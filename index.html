<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>그노시아 시뮬레이터</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg:#0f0f10;
      --panel:#151517;
      --panel2:#0b0b0c;
      --txt:#e9e9ea;
      --muted:#a6a6aa;
      --line:#2a2a2e;
      --accent:#78d7ff;
      --bad:#ff6b6b;
      --ok:#7CFF9B;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; padding:16px;
      background:var(--bg); color:var(--txt);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    h1{ margin:0 0 10px; font-size:28px; letter-spacing:0.5px; }
    h2{ margin:14px 0 8px; font-size:16px; }
    h3{ margin:10px 0 6px; font-size:13px; color:var(--muted); font-weight:700; }

    .wrap{ max-width:1200px; margin:0 auto; display:grid; gap:12px; }
    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border-radius: 12px;
      padding: 12px;
    }

    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; }
    .field{ flex: 1 1 220px; min-width: 180px; }
    .label{ display:block; font-size:12px; color:var(--muted); margin:0 0 4px; }

    input, select, button{
      font: inherit;
      font-size: 13px;
      border: 1px solid var(--line);
      background: var(--panel2);
      color: var(--txt);
      border-radius: 10px;
      padding: 8px 10px;
      outline: none;
    }
    input:focus, select:focus{ border-color: var(--accent); }

    button{ cursor:pointer; background:#17171a; }
    button:hover{ border-color: var(--accent); }
    button:disabled{ cursor:not-allowed; opacity:.45; }

    fieldset{
      margin: 10px 0 0;
      padding: 10px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: rgba(0,0,0,0.16);
    }
    legend{
      padding: 0 8px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
    }

    .kv-grid{
      display:grid;
      gap: 8px;
      grid-template-columns: repeat(6, minmax(120px, 1fr));
    }
    @media (max-width: 1100px){ .kv-grid{ grid-template-columns: repeat(3, minmax(120px, 1fr)); } }
    @media (max-width: 700px){ .kv-grid{ grid-template-columns: repeat(2, minmax(120px, 1fr)); } }

    .kv{
      border:1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 8px 10px;
    }
    .kv .k{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
    }
    .kv .k .hint{ color:#8c8c90; font-size: 11px; }
    .kv input{ width:100%; max-width:none; }

    .cmd-grid{
      display:grid;
      gap: 6px 10px;
      grid-template-columns: repeat(4, minmax(190px, 1fr));
    }
    @media (max-width: 1100px){ .cmd-grid{ grid-template-columns: repeat(3, minmax(190px, 1fr)); } }
    @media (max-width: 800px){ .cmd-grid{ grid-template-columns: repeat(2, minmax(190px, 1fr)); } }
    @media (max-width: 560px){ .cmd-grid{ grid-template-columns: 1fr; } }

    .cmd{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 6px 8px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.14);
    }
    .cmd input{ width:16px; height:16px; }
    .cmd .name{ font-size: 13px; }
    .cmd .req{ margin-left:auto; font-size:11px; color:#8c8c90; white-space:nowrap; }
    .cmd.disabled{ opacity:.42; }

    .toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top: 10px; }
    .toolbar input[type="file"]{ padding: 6px 8px; max-width: 280px; }

    .two-col{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 1000px){ .two-col{ grid-template-columns: 1fr; } }

    #charList, #log{
      border:1px solid var(--line);
      border-radius: 12px;
      background: rgba(0,0,0,0.18);
      padding: 10px;
      overflow:auto;
      height: 280px;
    }
    #log{ background:#000; }

    .char-entry{
      border:1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 8px 10px;
      margin-bottom: 8px;
      font-size: 12px;
      line-height: 1.45;
    }
    .char-entry .top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      margin-bottom: 6px;
    }
    .char-entry .top b{ font-size: 13px; }
    .char-entry .mini{ color: var(--muted); font-size: 11px; }

    .char-actions{
      display:flex; gap:6px; align-items:center;
    }
    .btn-mini{
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 10px;
    }
    .btn-warn{
      border-color: rgba(255,107,107,0.6);
    }
    .btn-warn:hover{
      border-color: var(--bad);
    }

    .logline{ margin:0 0 6px; }
    .tag{ color: var(--accent); }
    .bad{ color: var(--bad); }
    .ok{ color: var(--ok); }
    .note{ font-size: 12px; color: var(--muted); margin-top: 8px; }

    .edit-banner{
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px dashed rgba(120,215,255,0.6);
      color: var(--muted);
      background: rgba(120,215,255,0.06);
      display:none;
    }
    .edit-banner b{ color: var(--accent); }
    .edit-banner .right{ float:right; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>그노시아 시뮬레이터</h1>

    <div class="card" id="createCard">
      <h2>캐릭터 생성</h2>

      <div class="row">
        <div class="field">
          <span class="label">이름</span>
          <input id="name" placeholder="이름" />
        </div>
        <div class="field">
          <span class="label">성별</span>
          <select id="gender">
            <option value="남성">남성</option>
            <option value="여성">여성</option>
            <option value="범성">범성</option>
          </select>
        </div>
        <div class="field">
          <span class="label">나이</span>
          <input id="age" type="number" min="0" step="1" value="20" />
        </div>
      </div>

      <fieldset>
        <legend>스테이터스 (0~50)</legend>
        <div class="kv-grid" id="statsGrid"></div>
      </fieldset>

      <fieldset>
        <legend>성격 (0.00~1.00)</legend>
        <div class="kv-grid" id="persGrid"></div>
      </fieldset>

      <fieldset>
        <legend>사용 가능한 커맨드 선택 (체크)</legend>
        <div class="cmd-grid" id="commandList"></div>
        <div class="note">※ 스테이터스 조건을 충족하지 못하는 커맨드는 선택 불가(회색 처리)됩니다. 성향상 “사용하지 않을” 커맨드는 체크를 해제하세요.</div>
      </fieldset>

      <div class="toolbar">
        <button id="addChar">캐릭터 추가</button>
        <button id="applyEditBtn" disabled style="display:none;">수정 적용</button>
        <button id="cancelEditBtn" disabled style="display:none;">수정 취소</button>

        <button id="runBtn" disabled>실행</button>
        <button id="saveBtn">세이브</button>
        <input type="file" id="loadFile" accept=".json" />
        <button id="loadBtn">로드</button>
      </div>

      <div class="edit-banner" id="editBanner">
        <span>현재 <b>캐릭터 수정 모드</b>입니다. 수정 후 <b>수정 적용</b>을 누르세요.</span>
      </div>

      <div class="note">실행 버튼은 캐릭터 <b>5명 이상</b>부터 활성화됩니다. (낮 5턴 → 밤 2단계 진행)</div>
    </div>

    <div class="two-col">
      <div class="card">
        <h2>캐릭터 목록</h2>
        <div id="charList"></div>
      </div>

      <div class="card">
        <h2>게임 로그</h2>
        <div id="log"></div>
      </div>
    </div>
  </div>

  <script>
    const STAT_FIELDS = [
      { key:"charisma", label:"카리스마", hint:"0~50", step:"0.1", min:0, max:50 },
      { key:"logic", label:"논리력", hint:"0~50", step:"0.1", min:0, max:50 },
      { key:"acting", label:"연기력", hint:"0~50", step:"0.1", min:0, max:50 },
      { key:"charm", label:"귀염성", hint:"0~50", step:"0.1", min:0, max:50 },
      { key:"stealth", label:"스텔스", hint:"0~50", step:"0.1", min:0, max:50 },
      { key:"intuition", label:"직감", hint:"0~50", step:"0.1", min:0, max:50 },
    ];

    const PERS_FIELDS = [
      { key:"cheer", label:"쾌활함", hint:"0~1", step:"0.01", min:0, max:1 },
      { key:"social", label:"사회성", hint:"0~1", step:"0.01", min:0, max:1 },
      { key:"logical", label:"논리성향", hint:"0~1", step:"0.01", min:0, max:1 },
      { key:"kindness", label:"상냥함", hint:"0~1", step:"0.01", min:0, max:1 },
      { key:"desire", label:"욕망", hint:"0~1", step:"0.01", min:0, max:1 },
      { key:"courage", label:"용기", hint:"0~1", step:"0.01", min:0, max:1 },
    ];

    const COMMANDS = [
      { name:"의심한다", req:[] },
      { name:"의심에 동의한다", req:[] },
      { name:"부정한다", req:[] },
      { name:"변호한다", req:[] },
      { name:"변호에 가담한다", req:[] },
      { name:"감싼다", req:[] },
      { name:"함께 감싼다", req:[] },
      { name:"감사한다", req:[] },
      { name:"반론한다", req:[] },
      { name:"반론에 가담한다", req:[] },
      { name:"시끄러워", req:[] },
      { name:"역할을 밝힌다", req:[] },
      { name:"자신도 밝힌다", req:[] },
      { name:"역할을 밝혀라", req:[["charisma",10]] },
      { name:"과장해서 말한다", req:[["acting",15]] },
      { name:"동의를 구한다", req:[["charisma",25]] },
      { name:"반론을 막는다", req:[["charisma",40]] },
      { name:"얼버무린다", req:[["stealth",25]] },
      { name:"반격한다", req:[["logic",25],["acting",25]] },
      { name:"도움을 요청한다", req:[["acting",30]] },
      { name:"슬퍼한다", req:[["charm",25]] },
      { name:"속지마라", req:[["intuition",30]] },
      { name:"투표해라", req:[["logic",10]] },
      { name:"투표하지 마라", req:[["logic",15]] },
      { name:"반드시 인간이다", req:[["logic",20]] },
      { name:"반드시 적이다", req:[["logic",20]] },
      { name:"전원 배제해라", req:[["logic",30]] },
      { name:"잡담한다", req:[["stealth",10]] },
      { name:"협력하자", req:[["charm",15]] },
      { name:"인간이라고 말해", req:[["intuition",20]] },
      { name:"도게자한다", req:[["stealth",35]] },
    ];

    const el = (id)=>document.getElementById(id);
    const logBox = el("log");
    function addLog(text, cls=""){
      const p = document.createElement("p");
      p.className = "logline " + cls;
      p.textContent = text;
      logBox.appendChild(p);
      logBox.scrollTop = logBox.scrollHeight;
    }
    function clamp(n, min, max){
      if(Number.isNaN(n)) return min;
      return Math.min(max, Math.max(min, n));
    }
    function readNumber(id, min, max){
      const v = (document.getElementById(id).value ?? "").toString().trim();
      const n = parseFloat(v);
      return clamp(n, min, max);
    }

    let characters = [];
    let dayTurn = 0;
    let nightStep = 0;

    // ✅ 편집 모드 상태
    let editingIndex = null;

    function buildKVGrid(containerId, fields, defaultValue){
      const g = document.getElementById(containerId);
      g.innerHTML = "";
      fields.forEach(f=>{
        const box = document.createElement("div");
        box.className = "kv";
        box.innerHTML = `
          <div class="k">
            <span>${f.label}</span>
            <span class="hint">${f.hint}</span>
          </div>
          <div class="v">
            <input id="${f.key}" type="number" min="${f.min}" max="${f.max}" step="${f.step}" value="${defaultValue}" />
          </div>
        `;
        g.appendChild(box);
      });
    }

    buildKVGrid("statsGrid", STAT_FIELDS, 0);
    buildKVGrid("persGrid", PERS_FIELDS, 0);

    const cmdList = el("commandList");
    function buildCommandChecks(){
      cmdList.innerHTML = "";
      COMMANDS.forEach(cmd=>{
        const row = document.createElement("label");
        row.className = "cmd";
        const reqText = cmd.req.length
          ? cmd.req.map(([k,v])=>{
              const label = STAT_FIELDS.find(s=>s.key===k)?.label ?? k;
              return `${label}≥${v}`;
            }).join(", ")
          : "조건없음";
        row.innerHTML = `
          <input type="checkbox" data-cmd="${cmd.name}">
          <span class="name">${cmd.name}</span>
          <span class="req">${reqText}</span>
        `;
        cmdList.appendChild(row);
      });
    }
    buildCommandChecks();

    function getCurrentStats(){
      const stats = {};
      STAT_FIELDS.forEach(f=>{
        const val = readNumber(f.key, f.min, f.max);
        stats[f.key] = val;
      });
      return stats;
    }

    function refreshCommandAvailability(){
      const stats = getCurrentStats();
      const rows = cmdList.querySelectorAll(".cmd");
      rows.forEach(row=>{
        const checkbox = row.querySelector("input[type=checkbox]");
        const name = checkbox.dataset.cmd;
        const cmd = COMMANDS.find(c=>c.name===name);
        let ok = true;
        for(const [k,v] of cmd.req){
          if((stats[k] ?? 0) < v){ ok = false; break; }
        }
        checkbox.disabled = !ok;
        row.classList.toggle("disabled", !ok);
        if(!ok) checkbox.checked = false;
      });
    }

    STAT_FIELDS.forEach(f=>{
      el(f.key).addEventListener("input", refreshCommandAvailability);
    });
    refreshCommandAvailability();

    const charList = el("charList");

    function renderCharacters(){
      charList.innerHTML = "";
      characters.forEach((c, idx)=>{
        const div = document.createElement("div");
        div.className = "char-entry";
        const cmdCount = c.allowedCommands.length;

        div.innerHTML = `
          <div class="top">
            <b>#${idx+1} ${c.name}</b>
            <div class="char-actions">
              <button class="btn-mini" data-edit="${idx}">수정</button>
              <button class="btn-mini btn-warn" data-del="${idx}">삭제</button>
            </div>
          </div>
          <div class="mini">${c.gender} · ${c.age}세</div>
          <div class="mini">스테이터스: 카리스마 ${c.stats.charisma} / 논리력 ${c.stats.logic} / 연기력 ${c.stats.acting} / 귀염성 ${c.stats.charm} / 스텔스 ${c.stats.stealth} / 직감 ${c.stats.intuition}</div>
          <div class="mini">성격: 쾌활함 ${c.pers.cheer} / 사회성 ${c.pers.social} / 논리성향 ${c.pers.logical} / 상냥함 ${c.pers.kindness} / 욕망 ${c.pers.desire} / 용기 ${c.pers.courage}</div>
          <div class="mini">사용 커맨드(${cmdCount}): ${cmdCount ? c.allowedCommands.join(", ") : "없음"}</div>
        `;
        charList.appendChild(div);
      });

      // 버튼 이벤트(삭제/수정)
      charList.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const idx = parseInt(btn.dataset.del, 10);
          const name = characters[idx]?.name ?? "해당 캐릭터";
          if(confirm(`${name} 을(를) 삭제할까요?`)){
            // 편집 중인 캐릭터를 삭제하는 경우 편집 취소
            if(editingIndex === idx) exitEditMode(true);
            characters.splice(idx, 1);
            addLog(`[삭제] ${name} 삭제됨`, "bad");
            renderCharacters();
          }
        });
      });

      charList.querySelectorAll("button[data-edit]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const idx = parseInt(btn.dataset.edit, 10);
          enterEditMode(idx);
        });
      });

      el("runBtn").disabled = characters.length < 5;
    }

    function collectFormCharacter(){
      const name = el("name").value.trim();
      const gender = el("gender").value;
      const age = clamp(parseInt(el("age").value,10), 0, 999);

      if(!name){ alert("이름을 입력하세요."); return null; }
      if(Number.isNaN(age)){ alert("나이를 올바르게 입력해주세요."); return null; }

      const stats = {};
      STAT_FIELDS.forEach(f=>{
        const v = readNumber(f.key, f.min, f.max);
        stats[f.key] = Math.round(v*10)/10;
      });

      const pers = {};
      PERS_FIELDS.forEach(f=>{
        const v = readNumber(f.key, f.min, f.max);
        pers[f.key] = Math.round(v*100)/100;
      });

      const allowed = [];
      cmdList.querySelectorAll("input[type=checkbox]").forEach(chk=>{
        if(chk.checked && !chk.disabled) allowed.push(chk.dataset.cmd);
      });

      return { name, gender, age, stats, pers, allowedCommands: allowed };
    }

    function clearCommandChecks(){
      cmdList.querySelectorAll("input[type=checkbox]").forEach(chk=>{ chk.checked = false; });
    }

    // ✅ 편집 모드 진입: 폼에 캐릭터 값 채우기
    function enterEditMode(idx){
      const c = characters[idx];
      if(!c) return;

      editingIndex = idx;
      el("editBanner").style.display = "block";
      el("applyEditBtn").style.display = "";
      el("cancelEditBtn").style.display = "";
      el("applyEditBtn").disabled = false;
      el("cancelEditBtn").disabled = false;

      // 기본 버튼(추가) 비활성화
      el("addChar").disabled = true;

      // 폼 채우기
      el("name").value = c.name;
      el("gender").value = c.gender;
      el("age").value = c.age;

      STAT_FIELDS.forEach(f=>{ el(f.key).value = c.stats[f.key] ?? 0; });
      PERS_FIELDS.forEach(f=>{ el(f.key).value = c.pers[f.key] ?? 0; });

      refreshCommandAvailability();
      clearCommandChecks();
      // 허용 커맨드 체크
      const set = new Set(c.allowedCommands);
      cmdList.querySelectorAll("input[type=checkbox]").forEach(chk=>{
        if(!chk.disabled && set.has(chk.dataset.cmd)) chk.checked = true;
      });

      addLog(`[수정 모드] ${c.name} 편집 중...`, "tag");
      // 폼 있는 곳으로 스크롤(UX)
      el("createCard").scrollIntoView({behavior:"smooth", block:"start"});
    }

    // ✅ 편집 모드 종료
    function exitEditMode(silent=false){
      editingIndex = null;
      el("editBanner").style.display = "none";
      el("applyEditBtn").style.display = "none";
      el("cancelEditBtn").style.display = "none";
      el("applyEditBtn").disabled = true;
      el("cancelEditBtn").disabled = true;
      el("addChar").disabled = false;
      clearCommandChecks();
      refreshCommandAvailability();
      if(!silent) addLog("[수정 모드] 취소됨", "tag");
    }

    el("cancelEditBtn").addEventListener("click", ()=>{
      exitEditMode(false);
    });

    el("applyEditBtn").addEventListener("click", ()=>{
      if(editingIndex === null) return;
      const updated = collectFormCharacter();
      if(!updated) return;

      const prevName = characters[editingIndex]?.name ?? "";
      characters[editingIndex] = updated;
      addLog(`[수정 완료] ${prevName} → ${updated.name}`, "ok");
      renderCharacters();
      exitEditMode(true);
    });

    // ✅ 추가 버튼(편집 모드일 때는 disabled)
    el("addChar").addEventListener("click", ()=>{
      const c = collectFormCharacter();
      if(!c) return;

      characters.push(c);
      addLog(`[캐릭터 추가] ${c.name} 생성 완료`, "ok");
      renderCharacters();
      clearCommandChecks();
    });

    /**************
     * 세이브/로드 *
     **************/
    el("saveBtn").addEventListener("click", ()=>{
      const data = JSON.stringify(characters, null, 2);
      const blob = new Blob([data], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "gnosia_characters.json";
      a.click();
      URL.revokeObjectURL(url);
      addLog("[세이브] 캐릭터 목록 저장 완료", "ok");
    });

    el("loadBtn").addEventListener("click", ()=>{
      const file = el("loadFile").files?.[0];
      if(!file){ alert("로드할 파일을 선택하세요."); return; }
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const parsed = JSON.parse(r.result);
          if(!Array.isArray(parsed)) throw new Error("형식이 올바르지 않음");
          characters = parsed;
          exitEditMode(true);
          renderCharacters();
          addLog("[로드] 캐릭터 목록 불러오기 완료", "ok");
        }catch(e){
          alert("로드 실패: 파일 형식이 올바르지 않아요.");
        }
      };
      r.readAsText(file);
    });

    /*******************
     * 낮/밤 진행(로그) *
     *******************/
    function nightFreeActions(){
      const alive = characters.slice();
      if(alive.length < 2){
        addLog("밤 자유행동: 함께할 인원이 부족합니다.");
        return;
      }
      const picks = Math.min(3, Math.max(1, Math.floor(Math.random()*3)+1));
      for(let i=0;i<picks;i++){
        const a = alive[Math.floor(Math.random()*alive.length)];
        let b = alive[Math.floor(Math.random()*alive.length)];
        if(a===b) b = alive[(alive.indexOf(a)+1) % alive.length];
        addLog(`밤 자유행동: ${a.name} ↔ ${b.name} 함께 시간을 보냈다. (우호도 상승: 구현 대상)`);
      }
    }

    function gnosiaAttack(){
      const candidates = characters.slice();
      if(candidates.length === 0){
        addLog("밤 습격: 대상이 없습니다.");
        return;
      }
      const scored = candidates.map(c=>{
        const s = c.stats;
        const p = c.pers;
        const score =
          (50 - (s.stealth ?? 0)) * 0.8 +
          (s.logic ?? 0) * 0.6 +
          (p.desire ?? 0) * 10 +
          (s.charisma ?? 0) * 0.3;
        return { c, score };
      }).sort((a,b)=>b.score - a.score);

      const victim = scored[0].c;
      addLog(`밤 습격: ${victim.name}이(가) 그노시아에게 습격당했습니다.`, "bad");
    }

    el("runBtn").addEventListener("click", ()=>{
      if(characters.length < 5){
        alert("캐릭터가 5명 이상이어야 실행할 수 있습니다.");
        return;
      }

      if(dayTurn < 5){
        dayTurn++;
        addLog(`낮 턴 ${dayTurn}/5 진행...`, "tag");
        const speaker = characters[Math.floor(Math.random()*characters.length)];
        addLog(`${speaker.name}:[의심한다] (임시) 누군가 수상해.`, "");

        if(dayTurn === 5){
          addLog("낮이 종료되었습니다. 밤으로 넘어갑니다.", "tag");
          nightStep = 0;
        }
        return;
      }

      nightStep++;
      if(nightStep === 1){
        addLog("밤 1/2: 자유행동", "tag");
        nightFreeActions();
        return;
      }
      if(nightStep === 2){
        addLog("밤 2/2: 습격 처리", "tag");
        gnosiaAttack();
        dayTurn = 0;
        nightStep = 0;
        addLog("밤이 종료되었습니다. 다음 날로 넘어갑니다.", "tag");
        return;
      }
    });

    // 초기 로그
    addLog("로드 완료. 캐릭터를 5명 이상 만들고 실행 버튼을 눌러주세요.", "ok");
    renderCharacters();
  </script>
</body>
</html>
